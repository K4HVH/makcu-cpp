name: Auto Release

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.version_check.outputs.should_release }}
      is_update: ${{ steps.version_check.outputs.is_update }}
      version: ${{ steps.version_check.outputs.version }}
      tag: ${{ steps.version_check.outputs.tag }}
      changelog_b64: ${{ steps.changelog.outputs.changelog_b64 }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check version and release status
      id: version_check
      run: |
        # Extract current version from CMakeLists.txt
        CURRENT_VERSION=$(grep -oP 'project\(makcu-cpp VERSION \K[0-9]+\.[0-9]+\.[0-9]+' CMakeLists.txt)
        echo "Current version in CMakeLists.txt: $CURRENT_VERSION"
        
        TAG="v$CURRENT_VERSION"
        
        # Check if tag already exists
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, checking for new commits"
          
          # Get commits since this tag
          NEW_COMMITS=$(git rev-list ${TAG}..HEAD --count)
          if [ "$NEW_COMMITS" -gt 0 ]; then
            echo "Found $NEW_COMMITS new commits since $TAG, will update release"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "is_update=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits since $TAG"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "Tag $TAG does not exist, will create new release"
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "is_update=false" >> $GITHUB_OUTPUT
        fi
        
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Generate changelog
      if: steps.version_check.outputs.should_release == 'true'
      id: changelog
      run: |
        TAG="${{ steps.version_check.outputs.tag }}"
        
        echo "## Changes" > CHANGELOG.md
        
        # For both new releases and updates, include all commits since the previous version tag.
        PREVIOUS_TAG=$(git tag -l "v*.*.*" | grep -v "^$TAG$" | sort -V | tail -n1)
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous version tag found, getting all commits"
          COMMIT_RANGE=""
        else
          echo "Previous tag found: $PREVIOUS_TAG"
          echo "Getting commits from $PREVIOUS_TAG to HEAD (all commits for this version)"
          COMMIT_RANGE="${PREVIOUS_TAG}.."
        fi
        
        # Get commits with full messages, preserving line breaks
        git log --reverse --pretty=format:"COMMIT_START%n%B%nCOMMIT_END" ${COMMIT_RANGE}HEAD > commits.tmp
        
        # Process commits to format with bullets and proper indentation
        awk '
        /^COMMIT_START$/ { in_commit = 1; first_line = 1; next }
        /^COMMIT_END$/ { in_commit = 0; next }
        in_commit && NF > 0 {
          if (first_line) {
            print "* " $0
            first_line = 0
          } else {
            print "  " $0
          }
        }
        ' commits.tmp >> CHANGELOG.md
        
        rm -f commits.tmp
        
        echo "Generated changelog:"
        cat CHANGELOG.md
        
        CHANGELOG_B64=$(base64 -w 0 CHANGELOG.md)
        echo "changelog_b64=$CHANGELOG_B64" >> $GITHUB_OUTPUT

  build-windows:
    needs: check-and-release
    if: needs.check-and-release.outputs.should_release == 'true'
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3

    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build --config Release --parallel

    - name: Configure examples
      run: |
        cmake -S examples -B examples/build -G "Visual Studio 17 2022" -A x64 -Dmakcu-cpp_DIR="${{ github.workspace }}/build"

    - name: Build examples
      run: |
        cmake --build examples/build --config Release --parallel

    - name: Run C API smoke test
      run: |
        $env:Path = "${{ github.workspace }}\\build\\bin\\Release;$env:Path"
        .\examples\build\bin\Release\c_api_test.exe

    - name: Install NSIS
      run: |
        choco install nsis -y

    - name: Create packages
      run: |
        cd build
        cpack -G ZIP
        cpack -G NSIS

    - name: Prepare Windows artifacts
      shell: pwsh
      run: |
        $version = "${{ needs.check-and-release.outputs.version }}"
        Copy-Item "build/makcu-cpp-$version-win64.zip" "build/makcu-cpp-windows.zip" -Force -ErrorAction Stop
        Copy-Item "build/makcu-cpp-$version-win64.exe" "build/makcu-cpp-windows-installer.exe" -Force -ErrorAction Stop

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-packages
        path: |
          build/makcu-cpp-windows.zip
          build/makcu-cpp-windows-installer.exe
        if-no-files-found: error

  build-linux:
    needs: check-and-release
    if: needs.check-and-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libudev-dev pkg-config build-essential

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build --parallel

    - name: Configure examples
      run: |
        cmake -S examples -B examples/build -DCMAKE_BUILD_TYPE=Release -Dmakcu-cpp_DIR="${{ github.workspace }}/build"

    - name: Build examples
      run: |
        cmake --build examples/build --parallel

    - name: Run C API smoke test
      run: |
        LD_LIBRARY_PATH="${{ github.workspace }}/build/lib:${LD_LIBRARY_PATH}" ./examples/build/bin/c_api_test

    - name: Create packages
      run: |
        cd build
        cpack -G TGZ
        cpack -G DEB
        cpack -G RPM

    - name: Prepare Linux artifacts
      run: |
        VERSION="${{ needs.check-and-release.outputs.version }}"
        cp "build/makcu-cpp-${VERSION}-Linux.tar.gz" "build/makcu-cpp-linux.tar.gz"
        cp "build/makcu-cpp-${VERSION}-Linux.deb" "build/makcu-cpp-linux.deb"
        cp "build/makcu-cpp-${VERSION}-Linux.rpm" "build/makcu-cpp-linux.rpm"

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-packages
        path: |
          build/makcu-cpp-linux.tar.gz
          build/makcu-cpp-linux.deb
          build/makcu-cpp-linux.rpm
        if-no-files-found: error

  publish-release:
    needs: [check-and-release, build-windows, build-linux]
    if: needs.check-and-release.outputs.should_release == 'true' && needs.build-windows.result == 'success' && needs.build-linux.result == 'success'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-packages
        path: release-assets

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-packages
        path: release-assets

    - name: Create or update git tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        TAG="${{ needs.check-and-release.outputs.tag }}"
        IS_UPDATE="${{ needs.check-and-release.outputs.is_update }}"
        
        if [ "$IS_UPDATE" = "true" ]; then
          git tag -d "$TAG" || true
          git push origin ":refs/tags/$TAG" || true
        fi
        
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"

    - name: Delete existing release if updating
      if: needs.check-and-release.outputs.is_update == 'true'
      run: |
        TAG="${{ needs.check-and-release.outputs.tag }}"
        gh release delete "$TAG" --yes || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create release
      run: |
        CHANGELOG=$(echo "${{ needs.check-and-release.outputs.changelog_b64 }}" | base64 -d)
        
        cat > release_body.md << 'RELEASE_EOF'
        RELEASE_EOF
        
        echo "$CHANGELOG" >> release_body.md
        
        cat >> release_body.md << 'RELEASE_EOF'
        
        ## Downloads
        * Windows: `makcu-cpp-windows.zip`, `makcu-cpp-windows-installer.exe`
        * Linux: `makcu-cpp-linux.tar.gz`, `makcu-cpp-linux.deb`, `makcu-cpp-linux.rpm`
        
        ## Quick Start
        ```cpp
        #include <makcu.h>
        makcu::Device device;
        device.connect();
        device.mouseMove(100, 0);
        ```
        RELEASE_EOF
        
        gh release create "${{ needs.check-and-release.outputs.tag }}" \
          --title "MAKCU C++ ${{ needs.check-and-release.outputs.tag }}" \
          --notes-file release_body.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload release assets
      run: |
        gh release upload "${{ needs.check-and-release.outputs.tag }}" \
          release-assets/makcu-cpp-windows.zip \
          release-assets/makcu-cpp-windows-installer.exe \
          release-assets/makcu-cpp-linux.tar.gz \
          release-assets/makcu-cpp-linux.deb \
          release-assets/makcu-cpp-linux.rpm \
          --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
